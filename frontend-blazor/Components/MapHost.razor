@using Frontend.Constants
@using Microsoft.JSInterop
@inject IJSRuntime JS
@inject IConfiguration Config

<div id="@_mapId" class="map-host"></div>

@code {
  private string _mapId = $"map-{Guid.NewGuid():N}";
  private bool _initialized;
  private IJSObjectReference? _module;

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender || _initialized) return;
    _initialized = true;

    // Load the component-scoped module
    _module = await JS.InvokeAsync<IJSObjectReference>(
      "import", "./Components/MapHost.razor.js");

    // Call exported init
    string backendBase = Config["BackendBase"] ?? "";
    await _module.InvokeVoidAsync("init", _mapId, new {
      backendBase,
      center = AppConstants.DEFAULT_COORDINATE,
      zoom = AppConstants.DEFAULT_ZOOM
    });
  }

  public async Task FlyToAsync(double lng, double lat, int? zoom = null)
  {
    if (_module is not null)
      await _module.InvokeVoidAsync("flyTo", lng, lat, zoom);
  }
}
