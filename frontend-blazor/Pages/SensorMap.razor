
@page "/sensor/map"
@using Microsoft.JSInterop
@using System.Net.Http.Json
@using Frontend.Models
@inject IConfiguration Config
@inject HttpClient Http
@inject IJSRuntime JS

@code {
  private string query = string.Empty;
  private List<SensorDto> results = new List<SensorDto>();
  private bool searching = false;

  private async Task Load()
  {
    searching = true;
    StateHasChanged();
    string? backendBase = Config["BackendBase"] ?? "";
    string? url = $"{backendBase}/api/v1/sensors/search?q={Uri.EscapeDataString(query)}&limit=50";
    List<SensorDto>? data = await Http.GetFromJsonAsync<List<SensorDto>>(url);
    results = data ?? new List<SensorDto>();
    searching = false;
    StateHasChanged();
  }

  private async Task Select(SensorDto s)
  {
    await JS.InvokeVoidAsync("SensorMap.flyTo", s.Longitude, s.Latitude, 10);
  }

  private async Task OnInput(ChangeEventArgs e)
  {
    query = e.Value?.ToString() ?? string.Empty;
    await Load();
  }
}
