
@page "/sensors/map"
@using Microsoft.JSInterop
@using System.Net.Http.Json
@using Frontend.Models
@inject IConfiguration Config
@inject HttpClient Http
@inject IJSRuntime JS

<div class="layout">
  <div class="left">
    <div class="search">
      <input @bind="query" @bind:event="oninput" placeholder="Search for sensors..." style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px" />
    </div>
    <div class="list">
      @if (searching) {
        <div style="padding:8px">Searching...</div>
      }
      @foreach (SensorDto sensor in results)
      {
        <div class="item" @onclick="() => Select(sensor)">
          <div style="font-weight:600">@sensor.Name</div>
          <div style="font-size:12px;color:#555">@sensor.MacAddress</div>
          <div style="font-size:12px;color:#777">@sensor.Status</div>
        </div>
      }
    </div>
  </div>
  <div id="map"></div>
</div>

@code {
  private string query = string.Empty;
  private List<SensorDto> results = new List<SensorDto>();
  private bool searching = false;

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (firstRender)
    {
      string? backendBase = Config["BackendBase"] ?? "";
      await JS.InvokeVoidAsync("SensorMap.init", "map", new {
          backendBase,
          center = new []{ 174.7633, -36.8485 },
          zoom = 5
      });
      await Load();
    }
  }

  private async Task Load()
  {
    searching = true;
    StateHasChanged();
    string? backendBase = Config["BackendBase"] ?? "";
    string? url = $"{backendBase}/api/v1/sensors/search?q={Uri.EscapeDataString(query)}&limit=50";
    List<SensorDto>? data = await Http.GetFromJsonAsync<List<SensorDto>>(url);
    results = data ?? new();
    searching = false;
    StateHasChanged();
  }

  private async Task Select(SensorDto s)
  {
    await JS.InvokeVoidAsync("SensorMap.flyTo", s.Longitude, s.Latitude, 15);
  }

  private async Task OnInput(ChangeEventArgs e)
  {
    query = e.Value?.ToString() ?? string.Empty;
    await Load();
  }
}
